<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloTruck Pro Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/polyline/0.2.0/polyline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #ecf0f1; }
        .sidebar { width: 320px; position: absolute; top: 0; left: 0; bottom: 0; background: #2c3e50; color: white; padding: 20px; z-index: 1000; overflow-y: auto; }
        #map { position: absolute; top: 0; left: 320px; right: 0; bottom: 0; }
        .input-group { margin-bottom: 15px; position: relative; }
        input { width: 100%; padding: 10px; border-radius: 4px; border: none; background: #34495e; color: white; box-sizing: border-box; }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; color: black; z-index: 1001; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        #calcBtn { background: #27ae60; } #pdfBtn { background: #e74c3c; } #clearBtn { background: #95a5a6; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Route Planner</h2>
        <div class="input-group">
            <label>Origin</label>
            <input type="text" id="startAddr" placeholder="City or address..." oninput="suggest(this, 'startList')">
            <div id="startList" class="suggestions"></div>
        </div>
        <div class="input-group">
            <label>Destination</label>
            <input type="text" id="endAddr" placeholder="City or address..." oninput="suggest(this, 'endList')">
            <div id="endList" class="suggestions"></div>
        </div>
        <div class="input-group">
            <label>Height (Ft)</label>
            <input type="number" id="truckHeight" value="13.5" step="0.1">
        </div>
        <div class="input-group">
            <label>Weight (Lbs)</label>
            <input type="number" id="truckWeight" value="80000">
        </div>
        <div class="btn-group">
            <button id="calcBtn" onclick="runTruckFlow()">Calculate Route</button>
            <button id="pdfBtn" style="display:none;" onclick="generatePDF()">Download PDF</button>
            <button id="clearBtn" onclick="clearMap()">Reset</button>
        </div>
        <div id="statusMsg" style="color: #f1c40f; margin-top: 10px;"></div>
    </div>
    <script>
        const SERVER_DOMAIN = "hellotruck-api.duckdns.org"; 
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let routeLayer, lastTripData, selectedPoints = { start: null, end: null }, debounceTimer;

        async function suggest(input, listId) {
            const list = document.getElementById(listId);
            if (input.value.length < 3) { list.style.display = 'none'; return; }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const resp = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(input.value)}&limit=5`);
                const data = await resp.json();
                list.innerHTML = '';
                if (data.features.length > 0) {
                    list.style.display = 'block';
                    data.features.forEach(f => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = f.properties.name + (f.properties.city ? ", " + f.properties.city : "");
                        div.onclick = () => {
                            input.value = div.innerText;
                            list.style.display = 'none';
                            const p = { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] };
                            if (listId === 'startList') selectedPoints.start = p; else selectedPoints.end = p;
                        };
                        list.appendChild(div);
                    });
                }
            }, 300);
        }

        async function runTruckFlow() {
            if (!selectedPoints.start || !selectedPoints.end) { alert("Select locations from dropdown."); return; }
            const status = document.getElementById('statusMsg');
            status.innerText = "Routing...";
            try {
                const h = parseFloat(document.getElementById('truckHeight').value) * 0.3048;
                const w = parseFloat(document.getElementById('truckWeight').value) * 0.000453592;
                const body = {
                    locations: [selectedPoints.start, selectedPoints.end],
                    costing: "truck",
                    costing_options: { truck: { height: h, weight: w, hazmat: true } },
                    directions_options: { units: "miles" }
                };
                // Adding ?t= timestamp as a cache buster for the API call
                const response = await fetch(`https://${SERVER_DOMAIN}/route?t=${Date.now()}`, { method: 'POST', body: JSON.stringify(body) });
                const data = await response.json();
                if (!data.trip) throw new Error("No route.");
                lastTripData = data.trip;
                document.getElementById('pdfBtn').style.display = 'block';
                status.innerText = `Success: ${data.trip.summary.length.toFixed(1)} miles`;
                
                // DECODE SHAPE - Using window check to be 100% safe
                if (typeof polyline !== "undefined") {
                    const coords = polyline.decode(data.trip.legs[0].shape, 6);
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline(coords, {color: '#e74c3c', weight: 6}).addTo(map);
                    map.fitBounds(routeLayer.getBounds());
                } else { throw new Error("Polyline library failed to load. Please refresh."); }
            } catch (err) { alert(err.message); }
        }

        function clearMap() { if (routeLayer) map.removeLayer(routeLayer); location.reload(); }
        function generatePDF() { /* same as yesterday */ }
    </script>
</body>
</html>
    <div id="map"></div>
