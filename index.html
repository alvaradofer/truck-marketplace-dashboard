<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloTruck Professional Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/polyline/0.2.0/polyline.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #ecf0f1; }
        
        /* Navbar Styling */
        .navbar { 
            padding: 15px; background: #2c3e50; color: white; 
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        
        .search-group { display: flex; gap: 10px; }
        
        .options-group { 
            display: flex; gap: 15px; font-size: 13px; 
            border-left: 1px solid #7f8c8d; padding-left: 15px; align-items: center;
        }
        
        input[type="text"] { 
            padding: 10px; border-radius: 4px; border: none; width: 180px; 
            outline: none;
        }
        
        label { cursor: pointer; display: flex; align-items: center; gap: 5px; user-select: none; }
        
        button { 
            padding: 10px 18px; cursor: pointer; border: none; border-radius: 4px; 
            font-weight: bold; transition: background 0.2s; 
        }
        #calcBtn { background: #27ae60; color: white; }
        #calcBtn:hover { background: #219150; }
        #pdfBtn { background: #e74c3c; color: white; }
        #pdfBtn:hover { background: #c0392b; }
        #clearBtn { background: #7f8c8d; color: white; }
        #clearBtn:hover { background: #95a5a6; }
        
        /* Map Container */
        #map { height: calc(100vh - 85px); width: 100%; z-index: 1; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="search-group">
            <input type="text" id="startAddr" placeholder="Origin (City or ZIP)">
            <input type="text" id="endAddr" placeholder="Destination">
        </div>

        <div class="options-group">
            <label title="Avoid toll roads"><input type="checkbox" id="avoidTolls"> Avoid Tolls</label>
            <label title="Avoid major highways"><input type="checkbox" id="avoidHighways"> Avoid Highways</label>
            <span style="color:#bdc3c7; font-size: 12px;">| 13'6" • 80k • HAZMAT</span>
        </div>

        <button id="calcBtn" onclick="runTruckFlow()">Calculate Route</button>
        <button id="pdfBtn" style="display:none;" onclick="generatePDF()">Download PDF</button>
        <button id="clearBtn" onclick="clearMap()">Clear</button>
    </div>

    <div id="map"></div>

    <script>
        // 1. CONFIGURATION: Secure Domain
        const SERVER_DOMAIN = "hellotruck-api.duckdns.org"; 
        
        // Initialize Map centered on US
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        // Base Layers
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' });
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });
        
        // Live Traffic Overlay
        const traffic = L.tileLayer('https://{s}.tile.openstreetmap.org/hot/{z}/{x}/{y}.png', {
            opacity: 0.5,
            attribution: 'Traffic via OSM'
        });

        // Add Layers to Map
        streets.addTo(map);
        L.control.layers({ "Street Map": streets, "Satellite": satellite }, { "Live Traffic": traffic }).addTo(map);

        let routeLayer;
        let lastTripData = null; // Store data for PDF

        // 2. GEOCODING (Photon API)
        async function getCoords(address) {
            if (!address) throw new Error("Please enter an address.");
            const resp = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(address)}&limit=1`);
            const data = await resp.json();
            if (data.features && data.features.length > 0) {
                const [lon, lat] = data.features[0].geometry.coordinates;
                return { lat, lon };
            }
            throw new Error(`Location not found: ${address}`);
        }

        // 3. MAIN ROUTING LOGIC
        async function runTruckFlow() {
            const btn = document.getElementById('calcBtn');
            try {
                btn.innerText = "Routing...";
                
                // Get Coordinates
                const start = await getCoords(document.getElementById('startAddr').value);
                const end = await getCoords(document.getElementById('endAddr').value);

                // Build Request Payload
                const requestBody = {
                    locations: [start, end],
                    costing: "truck",
                    costing_options: {
                        truck: {
                            height: 4.11,   // 13'6" in meters
                            weight: 36.28,  // 80,000 lbs in metric tons
                            hazmat: true,   // Enable HAZMAT restrictions
                            use_tolls: document.getElementById('avoidTolls').checked ? 0.0 : 1.0,     // Penalty logic
                            use_highways: document.getElementById('avoidHighways').checked ? 0.0 : 1.0 
                        }
                    },
                    directions_options: { units: "miles" }
                };

                // Secure Fetch to Your Domain
                const response = await fetch(`https://${SERVER_DOMAIN}/route`, {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error("Server Error: Check your settings.");
                
                const data = await response.json();
                if (!data.trip) throw new Error("No route found for these truck specs.");

                // Success: Handle Data
                lastTripData = data.trip; 
                document.getElementById('pdfBtn').style.display = 'inline';
                
                // Decode Polyline (Precision 6)
                const coords = polyline.decode(data.trip.legs[0].shape, 6); 
                
                // Draw Route
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.polyline(coords, {color: '#d35400', weight: 6, opacity: 0.85}).addTo(map);
                map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                
                alert(`Route Calculated: ${data.trip.summary.length.toFixed(1)} miles`);

            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerText = "Calculate Route";
            }
        }

        // 4. PDF REPORT GENERATOR
        function generatePDF() {
            if (!lastTripData) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.text("Professional Driver Manifest", 14, 20);
            
            // Specs Section
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Vehicle Configuration: 13'6" Height | 80,000lb Weight | HAZMAT Safe`, 14, 28);
            
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Total Distance: ${lastTripData.summary.length.toFixed(1)} miles`, 14, 36);

            // Table Data
            const rows = lastTripData.legs[0].maneuvers.map(m => [
                m.instruction, 
                `${m.length.toFixed(1)} mi`
            ]);

            // Generate Table
            doc.autoTable({
                startY: 42,
                head: [['Instruction', 'Distance']],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] },
                styles: { fontSize: 10 }
            });

            doc.save(`Trip_Report_${Date.now()}.pdf`);
        }

        // 5. RESET FUNCTION
        function clearMap() {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = null;
            lastTripData = null;
            document.getElementById('pdfBtn').style.display = 'none';
            document.getElementById('startAddr').value = "";
            document.getElementById('endAddr').value = "";
            map.setView([39.8283, -98.5795], 4);
        }
    </script>
</body>
</html>
