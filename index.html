<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HelloTruck Pro Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* This Flexbox layout ensures the sidebar and map stay in their lanes */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar { 
            width: 320px; 
            min-width: 320px;
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            box-sizing: border-box;
            overflow-y: auto;
            z-index: 10;
        }
        
        #map { 
            flex-grow: 1; 
            height: 100%; 
            background: #cbdbe5;
        }

        h2 { margin-top: 0; border-bottom: 1px solid #7f8c8d; padding-bottom: 10px; font-family: sans-serif; }
        .input-group { margin-bottom: 15px; position: relative; font-family: sans-serif; }
        label { display: block; font-size: 12px; margin-bottom: 5px; color: #bdc3c7; }
        input { width: 100%; padding: 10px; border-radius: 4px; border: none; box-sizing: border-box; background: #34495e; color: white; }
        
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; color: black; z-index: 2000; border-radius: 4px; display: none; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .suggestion-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .suggestion-item:hover { background: #eee; }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 14px; font-family: sans-serif; }
        .checkbox-group input { width: auto; }
        
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        #calcBtn { background: #27ae60; }
        #pdfBtn { background: #e74c3c; display: none; }
        #statusMsg { margin-top:15px; color:#f1c40f; font-weight: bold; font-family: sans-serif; }
    </style>
</head>
    <div class="app-container">
    <div class="sidebar">
        <h2>Route Planner</h2>
        
        <div class="input-group">
            <label>Origin</label>
            <input type="text" id="startAddr" placeholder="Start city..." oninput="suggest(this, 'startList')">
            <div id="startList" class="suggestions"></div>
        </div>
        
        <div class="input-group">
            <label>Destination</label>
            <input type="text" id="endAddr" placeholder="End city..." oninput="suggest(this, 'endList')">
            <div id="endList" class="suggestions"></div>
        </div>

        <div class="input-group">
            <label>Truck Height (Feet)</label>
            <input type="number" id="truckHeight" value="13.5" step="0.1">
        </div>

        <div class="input-group">
            <label>Gross Weight (Lbs)</label>
            <input type="number" id="truckWeight" value="80000">
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="isHazmat" checked>
            <label for="isHazmat">HAZMAT Route</label>
        </div>

        <button id="calcBtn" onclick="runTruckFlow()">Calculate Route</button>
        <button id="pdfBtn" onclick="generatePDF()">Download Driver PDF</button>
        
        <div id="statusMsg"></div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/polyline-encoded@0.0.9/Polyline.encoded.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    // 1. Initialize Map
    const map = L.map('map').setView([39.82, -98.57], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // FIX: Force the map to fill its container correctly after 100ms
    setTimeout(() => { map.invalidateSize(); }, 200);

    const SERVER = "hellotruck-api.duckdns.org";
    let routeLayer, lastTripData, selectedPoints = { start: null, end: null }, timer;

    // 2. Autocomplete
    async function suggest(input, listId) {
        const list = document.getElementById(listId);
        if (input.value.length < 3) { list.style.display='none'; return; }
        clearTimeout(timer);
        timer = setTimeout(async () => {
            const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(input.value)}&limit=5`);
            const d = await r.json();
            list.innerHTML = '';
            if (d.features && d.features.length > 0) {
                list.style.display = 'block';
                d.features.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const name = [f.properties.name, f.properties.city, f.properties.state].filter(Boolean).join(', ');
                    div.innerText = name;
                    div.onclick = () => {
                        input.value = name;
                        list.style.display = 'none';
                        const p = { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] };
                        if (listId === 'startList') selectedPoints.start = p; else selectedPoints.end = p;
                    };
                    list.appendChild(div);
                });
            }
        }, 300);
    }

    // 3. Routing Logic
    async function runTruckFlow() {
        if (!selectedPoints.start || !selectedPoints.end) { alert("Please select locations from the dropdown."); return; }
        const status = document.getElementById('statusMsg');
        status.innerText = "Querying Engine...";

        try {
            const hMeters = parseFloat(document.getElementById('truckHeight').value) * 0.3048;
            const wTons = parseFloat(document.getElementById('truckWeight').value) * 0.000453592;

            const body = {
                locations: [selectedPoints.start, selectedPoints.end],
                costing: "truck",
                costing_options: { 
                    truck: { height: hMeters, weight: wTons, hazmat: document.getElementById('isHazmat').checked } 
                },
                directions_options: { units: "miles" }
            };

            const response = await fetch(`https://${SERVER}/route`, { method: 'POST', body: JSON.stringify(body) });
            const data = await response.json();
            
            if (!data.trip) throw new Error("No route found.");
            
            lastTripData = data.trip;
            document.getElementById('pdfBtn').style.display = 'block';
            status.innerText = `Found: ${data.trip.summary.length.toFixed(1)} miles`;

            // 4. Decode Polyline - Using Leaflet's built-in support via the plugin
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.Polyline.fromEncoded(data.trip.legs[0].shape, {
                color: '#e67e22',
                weight: 6,
                opacity: 0.8
            }).addTo(map);
            
            map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

        } catch (e) { 
            status.innerText = "Error calculating route.";
            console.error(e);
        }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("HelloTruck Professional Driver Report", 14, 20);
        const rows = lastTripData.legs[0].maneuvers.map(m => [m.instruction, `${m.length.toFixed(1)} mi`]);
        doc.autoTable({ startY: 30, head: [['Direction', 'Distance']], body: rows });
        doc.save("HelloTruck_Route.pdf");
    }
</script>
</body>
</html>
<body>
